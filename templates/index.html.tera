<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx Config Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        .container { max-width: 900px; padding-top: 20px; }
        pre { background: #2d2d2d; color: #e9ecef; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto; }
        .sticky-bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 15px; 
            border-top: 1px solid #dee2e6; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            z-index: 1000;
        }
        .pattern-item { background-color: #fff; }
        .card-header h2 { font-size: 1.25rem; margin: 0; }
        .status-inactive { opacity: 0.6; }
        
        /* Terminal Modal Style */
        .terminal-modal .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .terminal-modal .modal-header {
            border-bottom: 1px solid #333;
        }
        .terminal-modal .modal-title {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: #aaa;
        }
        .terminal-modal .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .terminal-modal .modal-body {
            padding: 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .terminal-log {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            margin: 0;
            overflow: auto;
            max-height: 70vh;
            white-space: pre-wrap;
            border-radius: 0 0 5px 5px;
        }
        .terminal-log::-webkit-scrollbar {
            width: 8px;
            background: #1e1e1e;
        }
        .terminal-log::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Nginx Config Manager</h1>

        <div id="alert-container"></div>

        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="nginx-config-tab" data-bs-toggle="tab" data-bs-target="#nginx-config" type="button" role="tab" aria-controls="nginx-config" aria-selected="true">Nginx Configuration</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="guardian-config-tab" data-bs-toggle="tab" data-bs-target="#guardian-config" type="button" role="tab" aria-controls="guardian-config" aria-selected="false">Guardian Configuration</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="listeners-tab" data-bs-toggle="tab" data-bs-target="#listeners" type="button" role="tab" aria-controls="listeners" aria-selected="false">Listeners</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">Preview & Publish</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="false">Status</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <!-- Tab 1: Nginx Configuration Template -->
            <div class="tab-pane fade show active" id="nginx-config" role="tabpanel" aria-labelledby="nginx-config-tab">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="h5 mb-0">Nginx Global Parameters</h3>
                    </div>
                    <div class="card-body">
                        <form action="/update_nginx" method="post">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="resolver" class="form-label">DNS Resolver IP</label>
                                    <input type="text" class="form-control" id="resolver" name="resolver" value="{{ resolver }}">
                                    <div class="form-text">Default: 8.8.8.8</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="user" class="form-label">Nginx User</label>
                                    <input type="text" class="form-control" id="user" name="user" value="{{ user }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="stream_module_path" class="form-label">Stream Module Path</label>
                                    <input type="text" class="form-control" id="stream_module_path" name="stream_module_path" value="{{ stream_module_path }}" required>
                                </div>
                                <div class="col-12 text-end mt-3">
                                    <button type="submit" class="btn btn-primary">Update Nginx Config</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Nginx Guardian Configuration -->
            <div class="tab-pane fade" id="guardian-config" role="tabpanel" aria-labelledby="guardian-config-tab">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h3 class="h5 mb-0">Nginx Guardian Configurations</h3>
                    </div>
                    <div class="card-body">
                        <form action="/update_guardian" method="post">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="nginx_binary_path" class="form-label">Nginx Binary Path</label>
                                    <input type="text" class="form-control" id="nginx_binary_path" name="nginx_binary_path" value="{{ nginx_binary_path }}" required>
                                </div>
                                <div class="col-12">
                                    <label for="nginx_working_dir" class="form-label">Nginx Working Directory</label>
                                    <input type="text" class="form-control" id="nginx_working_dir" name="nginx_working_dir" value="{{ nginx_working_dir }}" required>
                                </div>
                                <div class="col-12 text-end mt-3">
                                    <button type="submit" class="btn btn-primary">Update Guardian Config</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Nginx Stream Listener Configuration -->
            <div class="tab-pane fade" id="listeners" role="tabpanel" aria-labelledby="listeners-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="h5 card-title">Add New Listener</h3>
                        <form action="/add_listener" method="post" class="row row-cols-lg-auto g-3 align-items-center">
                            <div class="col-12">
                                <label class="visually-hidden" for="new_bind">Bind Address</label>
                                <div class="input-group">
                                    <div class="input-group-text">Bind</div>
                                    <input type="text" class="form-control" id="new_bind" name="bind" required placeholder="0.0.0.0" value="0.0.0.0">
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="visually-hidden" for="new_port">Port</label>
                                <div class="input-group">
                                    <div class="input-group-text">Port</div>
                                    <input type="number" class="form-control" id="new_port" name="port" required min="1" max="65535" placeholder="9092">
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">Add Listener</button>
                            </div>
                        </form>
                    </div>
                </div>

                {% for listener in listeners %}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">{{ listener.bind }}:{{ listener.port }}</h2>
                        <form action="/delete_listener" method="post" class="m-0">
                            <input type="hidden" name="bind" value="{{ listener.bind }}">
                            <input type="hidden" name="port" value="{{ listener.port }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete listener {{ listener.bind }}:{{ listener.port }}?')">Delete Listener</button>
                        </form>
                    </div>
                    <div class="card-body">
                        <h4 class="h6 text-muted mb-3">SNI Mappings (Whitelist & Overrides)</h4>
                        
                        <div class="list-group mb-3">
                            {% for mapping in listener.mappings %}
                            <div class="list-group-item d-flex justify-content-between align-items-center pattern-item">
                                <div>
                                    <div class="fw-bold">{{ mapping.pattern }}</div>
                                    <small class="text-muted">
                                        &rarr; 
                                        {% if mapping.target and mapping.target != "" %}
                                        Target: <code>{{ mapping.target }}</code>
                                        {% else %}
                                        <span class="fst-italic">Passthrough to SNI Host</span>
                                        {% endif %}
                                    </small>
                                </div>
                                <form action="/delete_pattern" method="post" class="m-0">
                                    <input type="hidden" name="bind" value="{{ listener.bind }}">
                                    <input type="hidden" name="port" value="{{ listener.port }}">
                                    <input type="hidden" name="pattern" value="{{ mapping.pattern }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">Remove</button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <h5 class="card-title h6">Add Mapping</h5>
                                <form action="/add_pattern" method="post" class="row g-3">
                                    <input type="hidden" name="bind" value="{{ listener.bind }}">
                                    <input type="hidden" name="port" value="{{ listener.port }}">
                                    <div class="col-md-6">
                                        <label class="form-label small">SNI Regex Pattern (prefix <code>~*</code> added automatically)</label>
                                        <input type="text" class="form-control form-control-sm" name="pattern" placeholder="e.g. ^example\.com$" required>
                                    </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Target Host:Port (Optional)</label>
                                    <input type="text" class="form-control form-control-sm" name="target" placeholder="e.g. 1.2.3.4:8080 (Default: passthrough)">
                                </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="submit" class="btn btn-secondary btn-sm w-100">Add Rule</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Tab 4: Preview, Publish page -->
            <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
                <div class="card mb-5">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="h5 mb-0">Generated Config Preview</h3>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyConfig()">Copy Config</button>
                    </div>
                    <div class="card-body p-0">
                        <pre class="m-0 border-0 rounded-0" id="config-preview">{{ config_preview }}</pre>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mb-5">
                    <form action="/apply" method="post" class="m-0">
                        <button type="submit" class="btn btn-primary btn-lg shadow">Publish to S3</button>
                    </form>
                </div>
            </div>

            <!-- Tab 5: NGGuard Load status page -->
            <div class="tab-pane fade" id="status" role="tabpanel" aria-labelledby="status-tab">
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h3 class="h5 mb-0">Deployment Status</h3>
                            <a href="/?tab=status" class="btn btn-sm btn-light text-primary">‚ü≥ Refresh</a>
                        </div>
                        <div class="d-flex gap-2">
                            {% if status_ok_count > 0 %}<span class="badge bg-light text-success">{{ status_ok_count }} OK</span>{% endif %}
                            {% if status_error_count > 0 %}<span class="badge bg-light text-danger">{{ status_error_count }} Error</span>{% endif %}
                            {% if status_inactive_count > 0 %}<span class="badge bg-light text-secondary">{{ status_inactive_count }} Inactive</span>{% endif %}
                        </div>
                    </div>
                    <div class="list-group list-group-flush">
                        {% if host_statuses | length == 0 %}
                            <div class="list-group-item text-center text-muted p-4">
                                No deployment status found. Publish config to S3 to see status.
                            </div>
                        {% else %}
                            {% for status in host_statuses %}
                            <div class="list-group-item list-group-item-action {% if status.status is starting_with("Inactive") %}status-inactive bg-light{% endif %}">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-2">
                                        {% if status.status == "OK" %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill text-success" viewBox="0 0 16 16">
                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                            </svg>
                                        {% elif status.status == "Error" %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-circle-fill text-danger" viewBox="0 0 16 16">
                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                                            </svg>
                                        {% elif status.status == "Inactive_OK" %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle-fill text-secondary" viewBox="0 0 16 16">
                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                            </svg>
                                        {% elif status.status == "Inactive_Error" %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x-circle-fill text-secondary" viewBox="0 0 16 16">
                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                                            </svg>
                                        {% endif %}
                                        
                                        <strong>{{ status.hostname }}</strong>
                                        
                                        {% if status.status is starting_with("Inactive") %}
                                            <span class="badge bg-secondary text-white" style="font-size: 0.7em;">Inactive (Old Config)</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="d-flex align-items-center gap-3">
                                        {% if status.status is containing("Error") %}
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#logModal-{{ loop.index0 }}">
                                                View Error
                                            </button>
                                        {% endif %}
                                        
                                        <small class="text-muted">{{ status.timestamp }}</small>
                                        {% if status.status is starting_with("Inactive") %}
                                        <form action="/delete_status" method="post" class="m-0" onsubmit="return confirm('Are you sure you want to remove the status for {{ status.hostname }}?');">
                                            <input type="hidden" name="hostname" value="{{ status.hostname }}">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary py-0 px-2" title="Remove status file">&times;</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {# Modals moved to bottom of page to avoid opacity/z-index issues #}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    {% if host_statuses | length > 0 %}
        {% for status in host_statuses %}
            {% if status.status is containing("Error") %}
            <!-- Terminal Modal for {{ status.hostname }} -->
            <div class="modal fade terminal-modal" id="logModal-{{ loop.index0 }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">nginx error logs found on {{ status.hostname }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="terminal-log">{{ status.details }}</pre>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyConfig() {
            const configText = document.getElementById('config-preview').innerText;
            navigator.clipboard.writeText(configText).then(function() {
                const btn = document.querySelector('button[onclick="copyConfig()"]');
                const originalText = btn.innerText;
                btn.innerText = 'Copied!';
                setTimeout(() => {
                    btn.innerText = originalText;
                }, 2000);
            }, function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy config to clipboard');
            });
        }

        // Check for status and message in URL
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        const message = urlParams.get('message');
        const tab = urlParams.get('tab');

        if (status && message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${status === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${decodeURIComponent(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.getElementById('alert-container').appendChild(alertDiv);
            
            // Clean up URL query params but keep the path
            window.history.replaceState({}, document.title, window.location.pathname + (tab ? `?tab=${tab}` : ''));
        }

        // Activate tab from URL
        if (tab) {
            // Map tab names to IDs if necessary, or strict match
            let tabId;
            if (tab === 'nginx-config') tabId = '#nginx-config-tab';
            else if (tab === 'guardian-config') tabId = '#guardian-config-tab';
            else if (tab === 'listeners') tabId = '#listeners-tab';
            else if (tab === 'preview') tabId = '#preview-tab';
            else if (tab === 'status') tabId = '#status-tab';

            if (tabId) {
                const tabTrigger = document.querySelector(tabId);
                if (tabTrigger) {
                    const tab = new bootstrap.Tab(tabTrigger);
                    tab.show();
                }
            }
        }
    </script>
</body>
</html>
